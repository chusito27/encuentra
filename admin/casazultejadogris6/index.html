<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrador de Menú</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <style>
        :root {
            --primary-color: #66bb6a; /* Un verde más claro para contraste */
            --secondary-color: #64b5f6; /* Un azul más claro */
            --danger-color: #ef5350; /* Un rojo más claro */
            --text-color: #eee;
            --bg-color: #303030; /* Fondo oscuro */
            --card-bg: #424242; /* Fondo de las tarjetas oscuro */
            --border-color: #555;
            --tab-active-bg: #555;
            --tab-inactive-bg: #333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 15px;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            position: relative; /* Para posicionar el botón de autenticación */
        }

        header .auth-buttons-container {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex; /* Para alinear los botones */
            gap: 10px; /* Espacio entre los botones */
        }

        header .auth-buttons-container button {
            padding: 8px 15px;
            font-size: 0.9rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        header .auth-buttons-container #openAuthModalButton {
            background-color: var(--secondary-color);
            color: white;
        }
        header .auth-buttons-container #openAuthModalButton:hover {
            background-color: #42a5f5;
        }

        header .auth-buttons-container #signOutButton {
            background-color: var(--danger-color);
            color: white;
        }
        header .auth-buttons-container #signOutButton:hover {
            background-color: #e53935;
        }


        h1, h2, h3 {
            color: var(--text-color);
            text-align: center;
            margin-bottom: 20px;
        }

        /* Tabs Styles */
        .tabs {
            display: flex;
            background-color: var(--tab-inactive-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .tab-button {
            flex-grow: 1;
            padding: 10px 15px;
            text-align: center;
            cursor: pointer;
            border: none;
            background-color: transparent;
            color: var(--text-color);
            font-size: 1rem;
            transition: background-color 0.3s ease;
        }

        .tab-button.active {
            background-color: var(--tab-active-bg);
        }

        .tab-button:hover {
            background-color: #616161;
        }

        .tab-content {
            display: none;
            padding: 25px;
            background-color: var(--card-bg);
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        .tab-content.active {
            display: block;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease;
            margin: 5px;
        }

        button:hover {
            background-color: #558b2f;
        }

        button.edit {
            background-color: var(--secondary-color);
        }
        button.edit:hover {
            background-color: #42a5f5;
        }
        button.delete {
            background-color: var(--danger-color);
        }
        button.delete:hover {
            background-color: #e53935;
        }
        button.cancel {
            background-color: #757575;
        }
        button.cancel:hover {
            background-color: #616161;
        }
        button.copy {
            background-color: #7B1FA2; /* A purple color for copy button */
        }
        button.copy:hover {
            background-color: #6A1B9A;
        }

        /* Action Buttons Container Style (for products/categories) */
        .action-buttons-container {
            text-align: right;
            margin-bottom: 20px;
        }
        .action-buttons-container button {
            background-color: var(--primary-color);
            margin-left: 10px;
        }

        /* Comercio Selector/Info */
        #comercioSelector {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        #comercioSelector select {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            background-color: #212121;
            color: var(--text-color);
            font-size: 1rem;
            margin-right: 10px;
        }
        #comercioSelector h3 {
            margin-top: 0;
            color: var(--primary-color);
        }
        #currentComercioInfo {
            margin-top: 10px;
            font-size: 0.9em;
            color: #ccc;
        }
        #currentComercioInfo strong {
            color: var(--text-color);
        }

        #comercioActions {
            margin-top: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #ccc;
        }

        .form-group input,
        .form-group input::placeholder,
        .form-group textarea,
        .form-group textarea::placeholder,
        .form-group select {
            color: var(--text-color);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-size: 1rem;
            box-sizing: border-box; /* Include padding in width */
            background-color: #212121;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            color: #ccc;
        }

        .checkbox-group input {
            margin-right: 10px;
            transform: scale(1.2);
            background-color: #212121;
            border: 1px solid var(--border-color);
        }

        .form-actions {
            text-align: right;
            margin-top: 20px;
        }

        .list-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: transform 0.2s ease;
            display: flex;
            flex-direction: column;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-bottom: 1px solid var(--border-color);
        }

        .card-content {
            padding: 15px;
            flex-grow: 1;
        }

        .card-content h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--primary-color);
            font-size: 1.3rem;
            text-align: left;
        }

        .card-content p {
            font-size: 0.9rem;
            color: #ddd;
            margin-bottom: 8px;
        }

        .card-content .price {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--text-color);
            margin-bottom: 5px;
        }
        .card-content .old-price {
            text-decoration: line-through;
            color: #999;
            font-size: 0.9rem;
            margin-left: 10px;
        }

        .card-tags span {
            display: inline-block;
            background-color: #555;
            color: #eee;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-right: 5px;
            margin-bottom: 5px;
        }

        .card-actions {
            padding: 10px 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            background-color: #333;
        }

        .card-actions button {
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        /* Category List Styling */
        #categoriesList {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 15px;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            margin-bottom: 25px;
        }

        #categoriesList .category-item {
            background-color: #424242;
            border: 1px solid #616161;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            color: #80cbc4;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #categoriesList .category-item button {
            background: none;
            border: none;
            color: #f48fb1;
            font-size: 1.1rem;
            cursor: pointer;
            padding: 0;
            margin: 0;
        }
        #categoriesList .category-item button:hover {
            color: #e91e63;
        }

        /* Image preview styles */
        .image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            margin-bottom: 10px;
        }
        .image-preview img {
            max-width: 100px;
            max-height: 100px;
            object-fit: cover;
            border-radius: 5px;
            border: 1px solid var(--border-color);
        }

        /* JSON Display Specific Styles (Removed in this version) */


        /* Modal Specific Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.7); /* Black w/ opacity */
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: auto;
            padding: 30px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            position: relative;
            animation-name: animatetop;
            animation-duration: 0.4s;
        }

        /* Add Animation */
        @keyframes animatetop {
            from {top: -300px; opacity: 0}
            to {top: 0; opacity: 1}
        }

        .modal-header {
            padding-bottom: 15px;
            border-bottom: 1-px solid var(--border-color);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            text-align: left;
            color: var(--text-color);
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-button:hover,
        .close-button:focus {
            color: white;
            text-decoration: none;
        }

        /* Message Modal Specific Styles */
        #messageModal .modal-content {
            max-width: 400px;
            text-align: center;
        }
        #messageModal .modal-header {
            justify-content: center;
            border-bottom: none;
            margin-bottom: 10px;
        }
        #messageModal .modal-header h2 {
            font-size: 1.5rem;
        }
        #messageModal p {
            margin-bottom: 20px;
            font-size: 1.1rem;
        }
        #messageModal button {
            padding: 10px 20px;
            font-size: 1rem;
        }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            .list-grid {
                grid-template-columns: 1fr;
            }
            .tabs {
                flex-direction: column;
            }
            .tab-button {
                border-bottom: 1px solid var(--border-color);
            }
            .tab-button:last-child {
                border-bottom: none;
            }
            .json-copy-button {
                position: static; /* Adjust for smaller screens */
                margin-top: 10px;
                display: block;
                width: fit-content;
                margin-left: auto;
                margin-right: auto;
            }
            .modal-content {
                width: 95%;
                padding: 15px;
            }
            header .auth-buttons-container {
                position: static;
                margin-top: 10px;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Administrador de Menú</h1>
        <div class="auth-buttons-container">
            <button id="openAuthModalButton">Iniciar Sesión</button>
            <button id="signOutButton" style="display: none;">Cerrar Sesión</button>
        </div>
    </header>

    <div id="comercioSelector">
        <h3>Seleccionar Comercio:</h3>
        <select id="selectComercio">
            <option value="">-- Seleccione un Comercio --</option>
        </select>
        <div id="currentComercioInfo"></div>
        <div id="comercioActions"></div> <!-- Container for edit/delete buttons -->
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab-button active" onclick="openTab('comercio-gestion')">Gestión de Comercios</button>
            <button class="tab-button" onclick="openTab('products')">Gestión de Productos</button>
            <button class="tab-button" onclick="openTab('categories')">Gestión de Categorías</button>
        </div>

        <div id="comercio-gestion" class="tab-content active">
            <div class="form-section">
                <h2>Añadir/Editar Comercio</h2>
                <form id="comercioForm">
                    <input type="hidden" id="comercioId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="comercioName">Nombre del Comercio</label>
                            <input type="text" id="comercioName" required>
                        </div>
                        <div class="form-group">
                            <label for="comercioShortDescription">Descripción Corta</label>
                            <input type="text" id="comercioShortDescription">
                        </div>
                        <div class="form-group">
                            <label for="comercioFullDescription">Descripción Completa</label>
                            <textarea id="comercioFullDescription"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="comercioSchedule">Horario</label>
                            <input type="text" id="comercioSchedule">
                        </div>
                        <div class="form-group">
                            <label for="comercioOrder">Orden (para mostrar)</label>
                            <input type="number" id="comercioOrder" value="999">
                        </div>
                        <div class="form-group">
                            <label for="comercioExternalLink">Enlace Externo (URL)</label>
                            <input type="text" id="comercioExternalLink">
                        </div>
                        <div class="form-group">
                            <label for="comercioMainImage">URL de la Imagen Principal</label>
                            <input type="text" id="comercioMainImage">
                            <div id="mainImagePreview" class="image-preview"></div>
                        </div>
                        <div class="form-group">
                            <label for="comercioAdditionalPhotos">URLs de Fotos Adicionales (separadas por coma)</label>
                            <input type="text" id="comercioAdditionalPhotos">
                            <div id="additionalPhotosPreview" class="image-preview"></div>
                        </div>
                        <div class="form-group">
                            <label for="comercioGoogleMapsLocation">Código de Google Maps Embed</label>
                            <input type="text" id="comercioGoogleMapsLocation">
                        </div>
                        <div class="form-group">
                            <label for="comercioPhoneNumber">Número de Teléfono</label>
                            <input type="text" id="comercioPhoneNumber">
                        </div>
                        <div class="form-group">
                            <label for="comercioWebsite">Sitio Web</label>
                            <input type="text" id="comercioWebsite">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit">Guardar Comercio</button>
                        <button type="button" class="cancel" id="cancelComercioEdit">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>


        <div id="products" class="tab-content">
            <div class="action-buttons-container">
                <button id="openAddProductModal">Añadir Nuevo Producto</button>
                <button id="openAddCategoryFromProductTabModal">Añadir Nueva Categoría</button>
            </div>
            <div class="list-section">
                <h2>Lista de Productos</h2>
                <div id="productsList" class="list-grid">
                    </div>
            </div>
        </div>

        <div id="categories" class="tab-content">
            <div class="form-section">
                <h2>Añadir/Editar Categoría</h2>
                <form id="categoryForm">
                    <input type="hidden" id="categoryId">
                    <div class="form-group">
                        <label for="categoryName">Nombre de la Categoría</label>
                        <input type="text" id="categoryName" required>
                    </div>
                    <div class="form-actions">
                        <button type="submit">Guardar Categoría</button>
                        <button type="button" class="cancel" id="cancelCategoryEdit">Cancelar</button>
                    </div>
                </form>
            </div>
            <h3>Categorías Existentes:</h3>
            <div id="categoriesList">
                </div>
        </div>

    </div>

    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Añadir Nuevo Producto</h2>
                <span class="close-button" data-modal="addProductModal">&times;</span>
            </div>
            <form id="addProductForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="newProductName">Nombre del Producto</label>
                        <input type="text" id="newProductName" required>
                    </div>
                    <div class="form-group">
                        <label for="newProductPrice">Precio</label>
                        <input type="number" id="newProductPrice" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="newProductOldPrice">Precio Anterior (opcional)</label>
                        <input type="number" id="newProductOldPrice" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="newProductImage">URL de la Imagen</label>
                        <input type="text" id="newProductImage">
                    </div>
                    <div class="form-group">
                        <label for="newProductDetails">Detalles del Producto</label>
                        <textarea id="newProductDetails"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="newProductDietaryInfo">Información Dietética</label>
                        <input type="text" id="newProductDietaryInfo">
                    </div>
                    <div class="form-group">
                        <label for="newProductOrder">Orden (para mostrar)</label>
                        <input type="number" id="newProductOrder" value="999">
                    </div>
                    <div class="form-group">
                        <label>Categorías</label>
                        <select id="newProductCategories" multiple size="5"></select>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="checkbox-group">
                        <input type="checkbox" id="newIsVegan">
                        <label for="newIsVegan">Vegano</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="newIsVegetarian">
                        <label for="newIsVegetarian">Vegetariano</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="newIsGlutenFree">
                        <label for="newIsGlutenFree">Sin Gluten</label>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit">Guardar Producto</button>
                    <button type="button" class="cancel" data-modal="addProductModal">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Editar Producto</h2>
                <span class="close-button" data-modal="editProductModal">&times;</span>
            </div>
            <form id="editProductForm">
                <input type="hidden" id="editProductId"> <div class="form-grid">
                    <div class="form-group">
                        <label for="editProductName">Nombre del Producto</label>
                        <input type="text" id="editProductName" required>
                    </div>
                    <div class="form-group">
                        <label for="editProductPrice">Precio</label>
                        <input type="number" id="editProductPrice" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="editProductOldPrice">Precio Anterior (opcional)</label>
                        <input type="number" id="editProductOldPrice" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="editProductImage">URL de la Imagen</label>
                        <input type="text" id="editProductImage">
                    </div>
                    <div class="form-group">
                        <label for="editProductDetails">Detalles del Producto</label>
                        <textarea id="editProductDetails"></textarea>
                    <div class="form-group">
                        <label for="editProductDietaryInfo">Información Dietética</label>
                        <input type="text" id="editProductDietaryInfo">
                    </div>
                    </div>
                    <div class="form-group">
                        <label for="editProductOrder">Orden (para mostrar)</label>
                        <input type="number" id="editProductOrder" value="999">
                    </div>
                    <div class="form-group">
                        <label>Categorías</label>
                        <select id="editProductCategories" multiple size="5"></select>
                    </div>
                </div>
                <div class="form-grid">
                    <div class="checkbox-group">
                        <input type="checkbox" id="editIsVegan">
                        <label for="editIsVegan">Vegano</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="editIsVegetarian">
                        <label for="editIsVegetarian">Vegetariano</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="editIsGlutenFree">
                        <label for="editIsGlutenFree">Sin Gluten</label>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit">Guardar Cambios</button>
                    <button type="button" class="cancel" data-modal="editProductModal">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="addCategoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Añadir Nueva Categoría</h2>
                <span class="close-button" data-modal="addCategoryModal">&times;</span>
            </div>
            <form id="addCategoryForm">
                <div class="form-group">
                    <label for="newCategoryName">Nombre de la Categoría</label>
                    <input type="text" id="newCategoryName" required>
                </div>
                <div class="form-actions">
                    <button type="submit">Guardar Categoría</button>
                    <button type="button" class="cancel" data-modal="addCategoryModal">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="authModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="authModalTitle">Iniciar Sesión / Registrarse</h2>
                <span class="close-button" data-modal="authModal">&times;</span>
            </div>
            <form id="authForm">
                <div class="form-group">
                    <label for="authEmail">Correo Electrónico</label>
                    <input type="email" id="authEmail" required>
                </div>
                <div class="form-group">
                    <label for="authPassword">Contraseña</label>
                    <input type="password" id="authPassword" required>
                </div>
                <div class="form-actions">
                    <button type="submit" id="signInButton">Iniciar Sesión</button>
                    <button type="button" id="signUpButton">Registrarse</button>
                    <button type="button" class="cancel" data-modal="authModal">Cancelar</button>
                </div>
                <p id="authError" style="color: var(--danger-color); text-align: center; margin-top: 10px; display: none;"></p>
            </form>
        </div>
    </div>

    <!-- Custom Message Modal (replaces alert()) -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="messageModalTitle"></h2>
                <span class="close-button" data-modal="messageModal">&times;</span>
            </div>
            <p id="messageModalText"></p>
            <button class="cancel" data-modal="messageModal">Aceptar</button>
        </div>
    </div>


    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAHr8NSBkLN_Jt062C4RtYFiulFC13tOLA",
            authDomain: "web2727.firebaseapp.com",
            projectId: "web2727",
            storageBucket: "web2727.firebasestorage.app",
            messagingSenderId: "899729264501",
            appId: "1:899729264501:web:e81099f4c1e7ba52ef4d3c",
            measurementId: "G-VE3F22HX79"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth(); // Inicializa Firebase Auth

        // ** Global Variable for Current Comercio **
        let currentComercioId = null;
        let currentComercioName = null;
        let allComercios = []; // To store all fetched comercios
        let currentUser = null; // Variable para almacenar el usuario autenticado

        // ** Firebase Collections (Dynamic based on currentComercioId) **
        const comerciosCollection = db.collection('comercios');
        const allowedUsersCollection = db.collection('allowedUsers'); // Nueva: Colección para usuarios permitidos

        // Functions to get dynamic subcollection references
        function getProductsCollection() {
            if (!currentComercioId) {
                console.error("Error: No hay comercio seleccionado.");
                return null;
            }
            return comerciosCollection.doc(currentComercioId).collection('products');
        }

        function getCategoriesCollection() {
            if (!currentComercioId) {
                console.error("Error: No hay comercio seleccionado.");
                return null;
            }
            return comerciosCollection.doc(currentComercioId).collection('categories');
        }


        // DOM Elements for Modals and Forms
        const openAddProductModalButton = document.getElementById('openAddProductModal');
        const addProductModal = document.getElementById('addProductModal');
        const addProductForm = document.getElementById('addProductForm');
        const newProductNameInput = document.getElementById('newProductName');
        const newProductPriceInput = document.getElementById('newProductPrice');
        const newProductOldPriceInput = document.getElementById('newProductOldPrice');
        const newProductImageInput = document.getElementById('newProductImage');
        const newProductDetailsInput = document.getElementById('newProductDetails');
        const newIsVeganInput = document.getElementById('newIsVegan');
        const newIsVegetarianInput = document.getElementById('newIsVegetarian');
        const newIsGlutenFreeInput = document.getElementById('newIsGlutenFree');
        const newProductDietaryInfoInput = document.getElementById('newProductDietaryInfo');
        const newProductCategoriesSelect = document.getElementById('newProductCategories');
        const newProductOrderInput = document.getElementById('newProductOrder');


        const editProductModal = document.getElementById('editProductModal');
        const editProductForm = document.getElementById('editProductForm');
        const editProductIdInput = document.getElementById('editProductId'); // Hidden field for Firebase Doc ID
        const editProductNameInput = document.getElementById('editProductName');
        const editProductPriceInput = document.getElementById('editProductPrice');
        const editProductOldPriceInput = document.getElementById('editProductOldPrice');
        const editProductImageInput = document.getElementById('editProductImage');
        const editProductDetailsInput = document.getElementById('editProductDetails');
        const editIsVeganInput = document.getElementById('editIsVegan');
        const editIsVegetarianInput = document.getElementById('editIsVegetarian');
        const editIsGlutenFreeInput = document.getElementById('editIsGlutenFree');
        const editProductDietaryInfoInput = document.getElementById('editProductDietaryInfo');
        const editProductCategoriesSelect = document.getElementById('editProductCategories');
        const editProductOrderInput = document.getElementById('editProductOrder');


        const productsListDiv = document.getElementById('productsList');

        // Category Management elements
        const categoryForm = document.getElementById('categoryForm');
        const categoryIdInput = document.getElementById('categoryId');
        const categoryNameInput = document.getElementById('categoryName');
        const cancelCategoryEditButton = document.getElementById('cancelCategoryEdit');
        const categoriesListDiv = document.getElementById('categoriesList');

        // New Category Modal elements
        const openAddCategoryFromProductTabModalButton = document.getElementById('openAddCategoryFromProductTabModal');
        const addCategoryModal = document.getElementById('addCategoryModal');
        const addCategoryForm = document.getElementById('addCategoryForm');
        const newCategoryNameInput = document.getElementById('newCategoryName');

        // ** Comercio DOM Elements **
        const comercioForm = document.getElementById('comercioForm');
        const comercioIdInput = document.getElementById('comercioId');
        const comercioNameInput = document.getElementById('comercioName');
        const comercioShortDescriptionInput = document.getElementById('comercioShortDescription');
        const comercioFullDescriptionInput = document.getElementById('comercioFullDescription');
        const comercioScheduleInput = document.getElementById('comercioSchedule');
        const comercioOrderInput = document.getElementById('comercioOrder'); // Nuevo campo de orden
        const comercioExternalLinkInput = document.getElementById('comercioExternalLink'); // Nuevo campo de enlace externo
        const comercioMainImageInput = document.getElementById('comercioMainImage');
        const comercioAdditionalPhotosInput = document.getElementById('comercioAdditionalPhotos');
        const comercioGoogleMapsLocationInput = document.getElementById('comercioGoogleMapsLocation');
        const comercioPhoneNumberInput = document.getElementById('comercioPhoneNumber');
        const comercioWebsiteInput = document.getElementById('comercioWebsite');
        const cancelComercioEditButton = document.getElementById('cancelComercioEdit');
        const mainImagePreviewDiv = document.getElementById('mainImagePreview');
        const additionalPhotosPreviewDiv = document.getElementById('additionalPhotosPreview');
        const comercioActionsDiv = document.getElementById('comercioActions');

        const selectComercio = document.getElementById('selectComercio');
        const currentComercioInfoDiv = document.getElementById('currentComercioInfo');

        // ** Auth DOM Elements **
        const authModal = document.getElementById('authModal');
        const authModalTitle = document.getElementById('authModalTitle');
        const authForm = document.getElementById('authForm');
        const authEmailInput = document.getElementById('authEmail');
        const authPasswordInput = document.getElementById('authPassword');
        const signInButton = document.getElementById('signInButton');
        const signUpButton = document.getElementById('signUpButton');
        const authErrorDisplay = document.getElementById('authError');
        const openAuthModalButton = document.getElementById('openAuthModalButton');
        const signOutButton = document.getElementById('signOutButton');

        // ** Message Modal Elements **
        const messageModal = document.getElementById('messageModal');
        const messageModalTitle = document.getElementById('messageModalTitle');
        const messageModalText = document.getElementById('messageModalText');


        let allCategories = []; // To store categories for the product form select

        // --- MODAL UTILITY FUNCTIONS ---
        function openModal(modalElement) {
            modalElement.style.display = 'flex';
        }

        function closeModal(modalElement) {
            modalElement.style.display = 'none';
        }

        // Custom function to display messages, replacing alert()
        function showMessage(title, message) {
            messageModalTitle.textContent = title;
            messageModalText.textContent = message;
            openModal(messageModal);
        }

        // Close modal if clicked outside of content
        window.addEventListener('click', (event) => {
            if (event.target === addProductModal) {
                closeModal(addProductModal);
            }
            if (event.target === editProductModal) {
                closeModal(editProductModal);
            }
            if (event.target === addCategoryModal) {
                closeModal(addCategoryModal);
            }
            if (event.target === authModal) { // Close auth modal
                closeModal(authModal);
            }
            if (event.target === messageModal) { // Close message modal
                closeModal(messageModal);
            }
        });

        // Close buttons for modals
        document.querySelectorAll('.close-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const modalId = e.target.dataset.modal;
                closeModal(document.getElementById(modalId));
            });
        });

        document.querySelectorAll('.modal .cancel').forEach(button => {
            button.addEventListener('click', (e) => {
                const modalId = e.target.dataset.modal;
                closeModal(document.getElementById(modalId));
                // Optionally reset the form on cancel
                if (modalId === 'addProductModal') addProductForm.reset();
                if (modalId === 'editProductModal') editProductForm.reset();
                if (modalId === 'addCategoryModal') addCategoryForm.reset();
                if (modalId === 'authModal') authForm.reset(); // Reset auth form
            });
        });


        // --- TAB FUNCTIONALITY ---
        async function openTab(tabId) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));

            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));

            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab-button[onclick="openTab('${tabId}')"]`).classList.add('active');

            // Logic based on authentication state and user authorization
            if (!currentUser && tabId !== 'comercio-gestion') {
                // Si no está autenticado y tratando de acceder a una pestaña restringida, redirigir a comercio-gestion
                showMessage('Acceso Denegado', 'Necesita iniciar sesión para acceder a esta sección.');
                openTab('comercio-gestion'); // Redirigir a una pestaña "segura"
                return; // Salir de la función para evitar cargar datos para la pestaña restringida
            }

            // Specific logic for each tab
            if (tabId === 'comercio-gestion') {
                await fetchComercios(); // Fetch comercios when this tab is opened
            } else if (tabId === 'products') {
                if (currentComercioId) {
                    await fetchProducts();
                    await fetchCategories(); // Also fetch categories for product form
                } else {
                    productsListDiv.innerHTML = '<p>Seleccione un comercio para gestionar sus productos.</p>';
                    newProductCategoriesSelect.innerHTML = '';
                    editProductCategoriesSelect.innerHTML = '';
                }
            } else if (tabId === 'categories') {
                if (currentComercioId) {
                    await fetchCategories();
                } else {
                    categoriesListDiv.innerHTML = '<p>Seleccione un comercio para gestionar sus categorías.</p>';
                }
            }
        }

        // --- FETCH AND RENDER FUNCTIONS (Comercios) ---

        async function fetchComercios() {
            // Check if authenticated. If not, clear lists and return early.
            if (!currentUser) {
                selectComercio.innerHTML = '<option value="">-- Inicie sesión para cargar comercios --</option>';
                currentComercioInfoDiv.innerHTML = 'No hay comercio seleccionado.';
                comercioActionsDiv.innerHTML = ''; // Clear action buttons
                currentComercioId = null;
                currentComercioName = null;
                allComercios = [];
                productsListDiv.innerHTML = '<p>Necesita iniciar sesión para gestionar productos.</p>';
                categoriesListDiv.innerHTML = '<p>Necesita iniciar sesión para gestionar categorías.</p>';
                return;
            }

            try {
                const snapshot = await comerciosCollection.orderBy('name', 'asc').get();
                allComercios = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateComercioSelect(allComercios);
                
                // Set the current selected comercio based on previous selection or first available
                if (currentComercioId && allComercios.some(c => c.id === currentComercioId)) {
                    selectComercio.value = currentComercioId;
                    const selectedComercio = allComercios.find(c => c.id === currentComercioId);
                    currentComercioName = selectedComercio ? selectedComercio.name : null;
                    updateCurrentComercioInfo(currentComercioId);
                    updateComercioForm(selectedComercio);
                } else if (allComercios.length > 0) {
                    currentComercioId = allComercios[0].id;
                    currentComercioName = allComercios[0].name;
                    selectComercio.value = currentComercioId;
                    const selectedComercio = allComercios[0];
                    updateCurrentComercioInfo(currentComercioId);
                    updateComercioForm(selectedComercio);
                } else {
                    currentComercioId = null;
                    currentComercioName = null;
                    updateCurrentComercioInfo(null);
                    comercioForm.reset();
                    comercioIdInput.value = '';
                }

                // Re-fetch data for the active tab AFTER the currentComercioId is set
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab && activeTab.id !== 'comercio-gestion') { // Only if not on the comercio management tab itself
                    await openTab(activeTab.id); 
                } else if (activeTab && activeTab.id === 'comercio-gestion' && !currentComercioId) {
                    // If on comercio-gestion tab and no comercios exist, clear products/categories lists.
                    productsListDiv.innerHTML = '<p>No hay productos disponibles. Añada un comercio primero.</p>';
                    categoriesListDiv.innerHTML = '<p>No hay categorías disponibles. Añada un comercio primero.</p>';
                    newProductCategoriesSelect.innerHTML = '';
                    editProductCategoriesSelect.innerHTML = '';
                }

            } catch (error) {
                console.error("Error fetching comercios: ", error);
                showMessage('Error de Carga', 'Error al cargar los comercios. Asegúrese de que las reglas de seguridad de Firestore permitan leer la colección "comercios".');
            }
        }


        function populateComercioSelect(comercios) {
            selectComercio.innerHTML = '<option value="">-- Seleccione un Comercio --</option>';
            comercios.forEach(comercio => {
                const option = document.createElement('option');
                option.value = comercio.id;
                option.textContent = comercio.name;
                selectComercio.appendChild(option);
            });
        }

        selectComercio.addEventListener('change', async (e) => {
            currentComercioId = e.target.value;
            const selectedComercio = allComercios.find(c => c.id === currentComercioId);
            currentComercioName = selectedComercio ? selectedComercio.name : null;
            updateCurrentComercioInfo(currentComercioId);
            updateComercioForm(selectedComercio);

            // Re-fetch data for the currently active tab
            const activeTab = document.querySelector('.tab-content.active');
            if (activeTab) {
                await openTab(activeTab.id); // Re-trigger tab logic to load data for new comercio
            }
        });

        function updateCurrentComercioInfo(comercioId) {
            currentComercioInfoDiv.innerHTML = '';
            comercioActionsDiv.innerHTML = ''; // Clear existing buttons
            if (comercioId) {
                const comercio = allComercios.find(c => c.id === comercioId);
                if (comercio) {
                    currentComercioInfoDiv.innerHTML = `
                        <strong>Comercio Activo:</strong> ${comercio.name}<br>
                        <strong>Descripción Corta:</strong> ${comercio.shortDescription || 'N/A'}<br>
                        <strong>Horario:</strong> ${comercio.schedule || 'N/A'}
                    `;
                    // Add edit and delete buttons
                    const editButton = document.createElement('button');
                    editButton.className = 'edit';
                    editButton.textContent = 'Editar Comercio';
                    editButton.addEventListener('click', () => editComercio(comercioId));

                    // REEMPLAZADO: Botón "Eliminar Comercio" con "Añadir Nuevo Comercio"
                    const addNewButton = document.createElement('button');
                    addNewButton.className = '';
                    addNewButton.textContent = 'Añadir Nuevo Comercio';
                    addNewButton.addEventListener('click', () => addNewComercio());

                    comercioActionsDiv.appendChild(editButton);
                    comercioActionsDiv.appendChild(addNewButton); // Se añade el nuevo botón
                }
            } else {
                currentComercioInfoDiv.innerHTML = 'No hay comercio seleccionado.';
            }
        }
        
        function updateComercioForm(comercio) {
            if (comercio) {
                comercioIdInput.value = comercio.id || '';
                comercioNameInput.value = comercio.name || '';
                comercioShortDescriptionInput.value = comercio.shortDescription || '';
                comercioFullDescriptionInput.value = comercio.fullDescription || '';
                comercioScheduleInput.value = comercio.schedule || '';
                comercioOrderInput.value = comercio.order || '999';
                comercioExternalLinkInput.value = comercio.externalLink || '';
                comercioMainImageInput.value = comercio.mainImage || '';
                comercioAdditionalPhotosInput.value = (comercio.additionalPhotos || []).join(', ');
                comercioGoogleMapsLocationInput.value = comercio.googleMapsLocation || '';
                comercioPhoneNumberInput.value = comercio.phoneNumber || '';
                comercioWebsiteInput.value = comercio.website || '';

                updateImagePreview(comercio.mainImage, mainImagePreviewDiv);
                updateImagePreview(comercio.additionalPhotos, additionalPhotosPreviewDiv);
            } else {
                comercioForm.reset();
                comercioIdInput.value = '';
                mainImagePreviewDiv.innerHTML = '';
                additionalPhotosPreviewDiv.innerHTML = '';
            }
        }


        // --- CRUD Operations for Comercios ---

        comercioForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Check if authenticated and authorized
            if (!currentUser) {
                showMessage('Acceso Denegado', 'Necesita iniciar sesión para guardar un comercio.');
                openModal(authModal); // Abre el modal de autenticación
                return;
            }
            const isAuthorized = await allowedUsersCollection.doc(currentUser.uid).get();
            if (!isAuthorized.exists) {
                showMessage('Acceso Denegado', 'Su cuenta no está autorizada para realizar esta acción.');
                return;
            }

            const id = comercioIdInput.value;
            const name = comercioNameInput.value.trim();
            const shortDescription = comercioShortDescriptionInput.value.trim();
            const fullDescription = comercioFullDescriptionInput.value.trim();
            const schedule = comercioScheduleInput.value.trim();
            const order = parseInt(comercioOrderInput.value, 10);
            const externalLink = comercioExternalLinkInput.value.trim();
            const mainImage = comercioMainImageInput.value.trim();
            const additionalPhotos = comercioAdditionalPhotosInput.value.split(',').map(url => url.trim()).filter(url => url);
            const googleMapsLocation = comercioGoogleMapsLocationInput.value.trim();
            const phoneNumber = comercioPhoneNumberInput.value.trim();
            const website = comercioWebsiteInput.value.trim();

            if (!name) {
                showMessage('Error', 'El nombre del comercio no puede estar vacío.');
                return;
            }

            const comercioData = { 
                name,
                shortDescription,
                fullDescription,
                schedule,
                order,
                externalLink,
                mainImage,
                additionalPhotos,
                googleMapsLocation,
                phoneNumber,
                website
            };

            try {
                if (id) {
                    await comerciosCollection.doc(id).update(comercioData);
                    console.log('Comercio actualizado con éxito!');
                } else {
                    await comerciosCollection.add(comercioData);
                    console.log('Comercio añadido con éxito!');
                }
                comercioForm.reset();
                comercioIdInput.value = '';
                mainImagePreviewDiv.innerHTML = '';
                additionalPhotosPreviewDiv.innerHTML = '';
                await fetchComercios(); // Re-fetch comercios to update lists and select
            } catch (error) {
                console.error("Error saving comercio: ", error);
                showMessage('Error al Guardar', 'Error al guardar el comercio. Asegúrese de tener permisos de escritura y autorización.');
            }
        });

        async function editComercio(id) {
            // Check if authenticated and authorized
            if (!currentUser) {
                showMessage('Acceso Denegado', 'Necesita iniciar sesión para editar un comercio.');
                openModal(authModal);
                return;
            }
            const isAuthorized = await allowedUsersCollection.doc(currentUser.uid).get();
            if (!isAuthorized.exists) {
                showMessage('Acceso Denegado', 'Su cuenta no está autorizada para realizar esta acción.');
                return;
            }

            try {
                const doc = await comerciosCollection.doc(id).get();
                if (doc.exists) {
                    const comercio = doc.data();
                    updateComercioForm(comercio);
                }
            } catch (error) {
                console.error("Error fetching comercio for edit: ", error);
                showMessage('Error de Carga', "Error al cargar el comercio para editar. Asegúrese de tener permisos de lectura y autorización.");
            }
        };

        // Función para añadir un nuevo comercio (reinicia el formulario)
        function addNewComercio() {
            comercioForm.reset();
            comercioIdInput.value = '';
            mainImagePreviewDiv.innerHTML = '';
            additionalPhotosPreviewDiv.innerHTML = '';
            // Deseleccionar el `<select>`
            selectComercio.value = '';
            updateCurrentComercioInfo(null);
            console.log('Formulario listo para añadir un nuevo comercio.');
        }

        async function deleteComercio(id) {
            // Check if authenticated and authorized
            if (!currentUser) {
                showMessage('Acceso Denegado', 'Necesita iniciar sesión para eliminar un comercio.');
                openModal(authModal);
                return;
            }
            const isAuthorized = await allowedUsersCollection.doc(currentUser.uid).get();
            if (!isAuthorized.exists) {
                showMessage('Acceso Denegado', 'Su cuenta no está autorizada para realizar esta acción.');
                return;
            }

            // Using custom confirmation instead of window.confirm
            if (true) { // Placeholder for custom confirmation logic
                // For simplicity, directly proceeding. In a real app, you'd show a confirmation modal.
                try {
                    // Start a batch to delete subcollections (products and categories)
                    const batch = db.batch();

                    // Delete products subcollection
                    const productsSnapshot = await comerciosCollection.doc(id).collection('products').get();
                    productsSnapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });

                    // Delete categories subcollection
                    const categoriesSnapshot = await comerciosCollection.doc(id).collection('categories').get();
                    categoriesSnapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });

                    // Commit the batch deletion of subcollections
                    await batch.commit();

                    // Finally, delete the comercio document itself
                    await comerciosCollection.doc(id).delete();
                    console.log('Comercio y sus datos asociados eliminados con éxito!');
                    showMessage('Eliminación Exitosa', 'Comercio y sus datos asociados eliminados con éxito!');
                    
                    // Reset current selected comercio if the deleted one was active
                    if (currentComercioId === id) {
                        currentComercioId = null;
                        currentComercioName = null;
                    }
                    await fetchComercios(); // Re-fetch comercios
                    // Clear product/category lists if no comercio is selected
                    productsListDiv.innerHTML = '<p>No hay productos disponibles. Seleccione o añada un comercio.</p>';
                    categoriesListDiv.innerHTML = '<p>No hay categorías disponibles. Seleccione o añada un comercio.</p>';
                    newProductCategoriesSelect.innerHTML = '';
                    editProductCategoriesSelect.innerHTML = '';

                } catch (error) {
                    console.error("Error deleting comercio: ", error);
                    showMessage('Error al Eliminar', 'Error al eliminar el comercio y sus datos. Asegúrese de tener permisos de escritura y autorización.');
                }
            }
        }

        cancelComercioEditButton.addEventListener('click', () => {
            comercioForm.reset();
            comercioIdInput.value = '';
            mainImagePreviewDiv.innerHTML = '';
            additionalPhotosPreviewDiv.innerHTML = '';
        });
        
        // Helper to update image previews
        function updateImagePreview(urlOrArray, container) {
            container.innerHTML = '';
            let urls = [];
            if (typeof urlOrArray === 'string' && urlOrArray) {
                urls = [urlOrArray];
            } else if (Array.isArray(urlOrArray)) {
                urls = urlOrArray;
            }

            urls.forEach(url => {
                if (url) {
                    const img = document.createElement('img');
                    img.src = url;
                    img.alt = 'Preview';
                    img.onerror = () => img.src = 'https://placehold.co/100x100/555/eee?text=Error';
                    container.appendChild(img);
                }
            });
        }
        
        // Event listeners for image preview
        comercioMainImageInput.addEventListener('input', (e) => {
            const url = e.target.value;
            updateImagePreview(url, mainImagePreviewDiv);
        });

        comercioAdditionalPhotosInput.addEventListener('input', (e) => {
            const urls = e.target.value.split(',').map(url => url.trim());
            updateImagePreview(urls, additionalPhotosPreviewDiv);
        });


        // --- FETCH AND RENDER FUNCTIONS (Products) ---

        async function fetchProducts() {
            // Check if authenticated (rules will also enforce this)
            if (!currentUser) { 
                productsListDiv.innerHTML = '<p>Necesita iniciar sesión para gestionar productos.</p>';
                return;
            }

            const productsColRef = getProductsCollection();
            if (!productsColRef) {
                productsListDiv.innerHTML = '<p>Seleccione un comercio para gestionar sus productos.</p>';
                return;
            }

            try {
                const snapshot = await productsColRef.orderBy('order', 'asc').get();
                const products = snapshot.docs.map(doc => ({ firebaseId: doc.id, ...doc.data() }));
                renderProducts(products);
            } catch (error) {
                console.error("Error fetching products: ", error);
                productsListDiv.innerHTML = '<p>Error al cargar los productos de este comercio. Asegúrese de que sus reglas de seguridad permitan leer los productos.</p>';
            }
        }

        async function fetchCategories() {
            // Check if authenticated (rules will also enforce this)
            if (!currentUser) {
                categoriesListDiv.innerHTML = '<p>Necesita iniciar sesión para gestionar categorías.</p>';
                newProductCategoriesSelect.innerHTML = '';
                editProductCategoriesSelect.innerHTML = '';
                return;
            }

            const categoriesColRef = getCategoriesCollection();
            if (!categoriesColRef) {
                categoriesListDiv.innerHTML = '<p>Seleccione un comercio para gestionar sus categorías.</p>';
                // Clear categories in product modals if no comercio is selected
                newProductCategoriesSelect.innerHTML = '';
                editProductCategoriesSelect.innerHTML = '';
                return;
            }

            try {
                const snapshot = await categoriesColRef.get();
                allCategories = snapshot.docs.map(doc => ({ id: doc.id, name: doc.data().name }));
                // Populate categories for product forms (both add and edit)
                renderCategoriesForProductForm(allCategories, newProductCategoriesSelect);
                renderCategoriesForProductForm(allCategories, editProductCategoriesSelect);

                // Populate categories for the management tab
                renderCategoriesForManagement(allCategories);
            }
            catch (error) {
                console.error("Error fetching categories: ", error);
                categoriesListDiv.innerHTML = '<p>Error al cargar las categorías de este comercio. Asegúrese de que sus reglas de seguridad permitan leer las categorías.</p>';
                newProductCategoriesSelect.innerHTML = '';
                editProductCategoriesSelect.innerHTML = '';
            }
        }

        function renderProducts(products) {
            productsListDiv.innerHTML = '';
            if (products.length === 0) {
                productsListDiv.innerHTML = '<p>No hay productos disponibles para este comercio.</p>';
                return;
            }
            products.forEach(product => {
                // Use the default image if product.image is empty or null
                const imageUrl = product.image || 'https://i.postimg.cc/vZQnpBpT/logo.png';
                const productCard = document.createElement('div');
                productCard.className = 'card';
                productCard.innerHTML = `
                    <img src="${imageUrl}" onerror="this.onerror=null;this.src='https://placehold.co/300x200/555/eee?text=No+Image';" alt="${product.name}" class="card-image">
                    <div class="card-content">
                        <h3>${product.name}</h3>
                        <p class="price">₡${product.price ? product.price.toFixed(2) : '0.00'}
                            ${product.oldPrice ? `<span class="old-price">₡${product.oldPrice.toFixed(2)}</span>` : ''}
                        </p>
                        <p>${product.productDetails}</p>
                        <p><strong>Info dietética:</strong> ${product.dietaryInfo || 'N/A'}</p>
                        <div class="card-tags">
                            ${product.isVegan ? '<span>Vegano 🌱</span>' : ''}
                            ${product.isVegetarian ? '<span>Vegetariano 🥗</span>' : ''}
                            ${product.isGlutenFree ? '<span>Sin Gluten 🌾</span>' : ''}
                            ${product.categories && product.categories.length > 0 ? product.categories.map(cat => `<span>${cat}</span>`).join('') : ''}
                        </div>
                        <p>Orden: ${product.order || 999}</p>
                    </div>
                    <div class="card-actions">
                        <button class="edit" data-firebase-id="${product.firebaseId}">Editar</button>
                        <button class="delete" data-firebase-id="${product.firebaseId}">Eliminar</button>
                    </div>
                `;
                productsListDiv.appendChild(productCard);
            });

            document.querySelectorAll('.card-actions .edit').forEach(button => {
                button.addEventListener('click', (e) => editProduct(e.target.dataset.firebaseId));
            });
            document.querySelectorAll('.card-actions .delete').forEach(button => {
                button.addEventListener('click', (e) => deleteProduct(e.target.dataset.firebaseId));
            });
        }

        function renderCategoriesForProductForm(categories, selectElement) {
            selectElement.innerHTML = '';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.name; // Use name as value for display purposes
                option.textContent = category.name;
                selectElement.appendChild(option);
            });
        }

        function renderCategoriesForManagement(categories) {
            categoriesListDiv.innerHTML = '';
            if (categories.length === 0) {
                categoriesListDiv.innerHTML = '<p>No hay categorías disponibles para este comercio.</p>';
                return;
            }
            categories.forEach(category => {
                const categoryItem = document.createElement('span');
                categoryItem.className = 'category-item';
                categoryItem.innerHTML = `
                    ${category.name}
                    <button class="delete-category" data-id="${category.id}">x</button>
                `;
                categoriesListDiv.appendChild(categoryItem);
            });

            document.querySelectorAll('.delete-category').forEach(button => {
                button.addEventListener('click', (e) => deleteCategory(e.target.dataset.id));
            });
        }

        // --- PRODUCT CRUD OPERATIONS (Using Modals) ---

        // Open Add Product Modal
        openAddProductModalButton.addEventListener('click', async () => {
            if (!currentUser) { // Check authentication
                showMessage('Acceso Denegado', 'Necesita iniciar sesión para añadir un producto.');
                openModal(authModal); // Prompt login
                return;
            }
            const isAuthorized = await allowedUsersCollection.doc(currentUser.uid).get();
            if (!isAuthorized.exists) {
                showMessage('Acceso Denegado', 'Su cuenta no está autorizada para realizar esta acción.');
                return;
            }
            if (!currentComercioId) {
                showMessage('Error', 'Por favor, seleccione un comercio primero.');
                return;
            }
            addProductForm.reset(); // Clear the form when opening
            newProductOrderInput.value = '999'; // Reset default order
            // Deselect all categories
            Array.from(newProductCategoriesSelect.options).forEach(option => option.selected = false);
            openModal(addProductModal);
        });

        // Add Product Form Submission
        addProductForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentUser) { // Double check authentication
                showMessage('Acceso Denegado', 'Necesita iniciar sesión para guardar un producto.');
                return;
            }

            const productsColRef = getProductsCollection();
            if (!productsColRef) return; // Should not happen due to button check, but good for safety

            const productData = {
                name: newProductNameInput.value,
                price: parseFloat(newProductPriceInput.value),
                oldPrice: newProductOldPriceInput.value ? parseFloat(newProductOldPriceInput.value) : null,
                image: newProductImageInput.value, // Use the provided image URL
                productDetails: newProductDetailsInput.value,
                isVegan: newIsVeganInput.checked,
                isVegetarian: newIsVegetarianInput.checked,
                isGlutenFree: newIsGlutenFreeInput.checked,
                dietaryInfo: newProductDietaryInfoInput.value,
                categories: Array.from(newProductCategoriesSelect.selectedOptions).map(option => option.value),
                order: parseInt(newProductOrderInput.value),
                comercioId: currentComercioId // Associate product with current comercio
            };

            try {
                await productsColRef.add(productData);
                console.log('Producto añadido con éxito!');
                showMessage('Éxito', 'Producto añadido con éxito!');
                closeModal(addProductModal); // Close modal on success
                addProductForm.reset();
                newProductOrderInput.value = '999';
                Array.from(newProductCategoriesSelect.options).forEach(option => option.selected = false);
                fetchProducts();
            } catch (error) {
                console.error("Error saving product: ", error);
                showMessage('Error al Guardar', 'Error al guardar el producto.');
            }
        });


        // Edit Product Function (opens modal and populates form)
        async function editProduct(firebaseDocId) {
            if (!currentUser) { // Check authentication
                showMessage('Acceso Denegado', 'Necesita iniciar sesión para editar un producto.');
                openModal(authModal);
                return;
            }
            const isAuthorized = await allowedUsersCollection.doc(currentUser.uid).get();
            if (!isAuthorized.exists) {
                showMessage('Acceso Denegado', 'Su cuenta no está autorizada para realizar esta acción.');
                return;
            }
            const productsColRef = getProductsCollection();
            if (!productsColRef) return;

            try {
                const doc = await productsColRef.doc(firebaseDocId).get();
                if (doc.exists) {
                    const product = doc.data();
                    editProductIdInput.value = doc.id; // Store Firebase doc ID for update operation
                    editProductNameInput.value = product.name;
                    editProductPriceInput.value = product.price;
                    editProductOldPriceInput.value = product.oldPrice || '';
                    editProductImageInput.value = product.image;
                    editProductDetailsInput.value = product.productDetails;
                    editIsVeganInput.checked = product.isVegan;
                    editIsVegetarianInput.checked = product.isVegetarian;
                    editIsGlutenFreeInput.checked = product.isGlutenFree;
                    editProductDietaryInfoInput.value = product.dietaryInfo;
                    editProductOrderInput.value = product.order || 999;

                    Array.from(editProductCategoriesSelect.options).forEach(option => {
                        option.selected = product.categories && product.categories.includes(option.value);
                    });
                    openModal(editProductModal); // Open the edit modal
                }
            } catch (error) {
                    console.error("Error al obtener el producto para editar: ", error);
                    showMessage('Error de Carga', "Error al cargar el producto para editar.");
            }
        }

        // Edit Product Form Submission
        editProductForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentUser) { // Double check authentication
                showMessage('Acceso Denegado', 'Necesita iniciar sesión para guardar cambios en el producto.');
                return;
            }

            const productsColRef = getProductsCollection();
            if (!productsColRef) return;

            const firebaseDocId = editProductIdInput.value;

            const productData = {
                name: editProductNameInput.value,
                price: parseFloat(editProductPriceInput.value),
                oldPrice: editProductOldPriceInput.value ? parseFloat(editProductOldPriceInput.value) : null,
                image: editProductImageInput.value, // Use the provided image URL
                productDetails: editProductDetailsInput.value,
                isVegan: editIsVeganInput.checked,
                isVegetarian: editIsVegetarianInput.checked,
                isGlutenFree: editIsGlutenFreeInput.checked,
                dietaryInfo: editProductDietaryInfoInput.value,
                categories: Array.from(editProductCategoriesSelect.selectedOptions).map(option => option.value),
                order: parseInt(editProductOrderInput.value),
                comercioId: currentComercioId // Ensure comercioId is preserved/added during edit
            };

            try {
                await productsColRef.doc(firebaseDocId).update(productData);
                console.log('Producto actualizado con éxito!');
                showMessage('Éxito', 'Producto actualizado con éxito!');
                closeModal(editProductModal); // Close modal on success
                editProductForm.reset();
                editProductOrderInput.value = '999';
                Array.from(editProductCategoriesSelect.options).forEach(option => option.selected = false);
                fetchProducts();
            } catch (error) {
                console.error("Error updating product: ", error);
                showMessage('Error al Actualizar', 'Error al actualizar el producto.');
            }
        });


        async function deleteProduct(firebaseDocId) {
            if (!currentUser) { // Check authentication
                showMessage('Acceso Denegado', 'Necesita iniciar sesión para eliminar un producto.');
                openModal(authModal);
                return;
            }
            const isAuthorized = await allowedUsersCollection.doc(currentUser.uid).get();
            if (!isAuthorized.exists) {
                showMessage('Acceso Denegado', 'Su cuenta no está autorizada para realizar esta acción.');
                return;
            }
            const productsColRef = getProductsCollection();
            if (!productsColRef) return;

            // Using custom confirmation instead of window.confirm
            if (true) { // Placeholder for custom confirmation logic
                // For simplicity, directly proceeding. In a real app, you'd show a confirmation modal.
                try {
                    await productsColRef.doc(firebaseDocId).delete();
                    console.log('Producto eliminado con éxito!');
                    showMessage('Eliminación Exitosa', 'Producto eliminado con éxito!');
                    fetchProducts();
                } catch (error) {
                    console.error("Error deleting product: ", error);
                    showMessage('Error al Eliminar', 'Error al eliminar el producto.');
                }
            }
        }

        // --- CATEGORY CRUD OPERATIONS --- (Mainly for Category Tab)

        // Open Add Category Modal from Product Tab
        openAddCategoryFromProductTabModalButton.addEventListener('click', async () => {
            if (!currentUser) { // Check authentication
                showMessage('Acceso Denegado', 'Necesita iniciar sesión para añadir una categoría.');
                openModal(authModal);
                return;
            }
            const isAuthorized = await allowedUsersCollection.doc(currentUser.uid).get();
            if (!isAuthorized.exists) {
                showMessage('Acceso Denegado', 'Su cuenta no está autorizada para realizar esta acción.');
                return;
            }
            if (!currentComercioId) {
                showMessage('Error', 'Por favor, seleccione un comercio primero.');
                return;
            }
            addCategoryForm.reset();
            openModal(addCategoryModal);
        });

        // Add Category Form Submission (from new modal)
        addCategoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentUser) { // Double check authentication
                showMessage('Acceso Denegado', 'Necesita iniciar sesión para guardar una categoría.');
                return;
            }

            const categoriesColRef = getCategoriesCollection();
            if (!categoriesColRef) return;

            const name = newCategoryNameInput.value.trim();

            if (!name) {
                showMessage('Error', 'El nombre de la categoría no puede estar vacío.');
                return;
            }

            const exists = allCategories.some(cat => cat.name.toLowerCase() === name.toLowerCase());
            if (exists) {
                showMessage('Error', 'Ya existe una categoría con ese nombre. Por favor, elige otro.');
                return;
            }

            const categoryData = { name, comercioId: currentComercioId }; // Associate category with current comercio

            try {
                await categoriesColRef.add(categoryData);
                console.log('Categoría añadida con éxito!');
                showMessage('Éxito', 'Categoría añadida con éxito!');
                closeModal(addCategoryModal); // Close the modal
                addCategoryForm.reset(); // Reset the form
                fetchCategories(); // Re-fetch categories to update dropdowns and category list
                fetchProducts(); // Re-fetch products to ensure category tags are updated, and JSON
            } catch (error) {
                console.error("Error saving category: ", error);
                showMessage('Error al Guardar', 'Error al guardar la categoría.');
            }
        });

        // Edit/Save Category from Category Tab (original form)
        categoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentUser) { // Double check authentication
                showMessage('Acceso Denegado', 'Necesita iniciar sesión para guardar cambios en la categoría.');
                return;
            }

            const categoriesColRef = getCategoriesCollection();
            if (!categoriesColRef) return;

            const id = categoryIdInput.value;
            const name = categoryNameInput.value.trim();

            if (!name) {
                showMessage('Error', 'El nombre de la categoría no puede estar vacío.');
                return;
            }

            const exists = allCategories.some(cat => cat.name.toLowerCase() === name.toLowerCase() && cat.id !== id);
            if (exists) {
                showMessage('Error', 'Ya existe una categoría con ese nombre. Por favor, elige otro.');
                return;
            }

            const categoryData = { name, comercioId: currentComercioId }; // Ensure comercioId is preserved/added during edit

            try {
                if (id) {
                    const oldCategoryName = allCategories.find(cat => cat.id === id).name;
                    await categoriesColRef.doc(id).update(categoryData);

                    // Update products that have this category (only within this comercio)
                    const productsColForUpdate = getProductsCollection();
                    if (productsColForUpdate) {
                        const productsWithOldCategory = await productsColForUpdate.where('categories', 'array-contains', oldCategoryName).get();
                        const batch = db.batch();
                        productsWithOldCategory.docs.forEach(doc => {
                            const product = doc.data();
                            const updatedCategories = product.categories.map(cat => cat === oldCategoryName ? name : cat);
                            batch.update(doc.ref, { categories: updatedCategories });
                        });
                        await batch.commit();
                    }

                    console.log('Categoría actualizada con éxito!');
                    showMessage('Éxito', 'Categoría actualizada con éxito!');
                } else {
                    // This part is for adding from the original form, but should primarily be handled by modal now.
                    await categoriesColRef.add(categoryData);
                    console.log('Categoría añadida con éxito!');
                    showMessage('Éxito', 'Categoría añadida con éxito!');
                }
                categoryForm.reset();
                categoryIdInput.value = '';
                fetchCategories();
                fetchProducts(); // Re-fetch products to reflect category changes and update JSON
            } catch (error) {
                console.error("Error saving category: ", error);
                showMessage('Error al Guardar', 'Error al guardar la categoría.');
            }
        });

        async function deleteCategory(id) {
            if (!currentUser) { // Check authentication
                showMessage('Acceso Denegado', 'Necesita iniciar sesión para eliminar una categoría.');
                openModal(authModal);
                return;
            }
            const isAuthorized = await allowedUsersCollection.doc(currentUser.uid).get();
            if (!isAuthorized.exists) {
                showMessage('Acceso Denegado', 'Su cuenta no está autorizada para realizar esta acción.');
                return;
            }
            const categoriesColRef = getCategoriesCollection();
            if (!categoriesColRef) return;

            // Using custom confirmation instead of window.confirm
            if (true) { // Placeholder for custom confirmation logic
                // For simplicity, directly proceeding. In a real app, you'd show a confirmation modal.
                try {
                    const categoryToDelete = allCategories.find(cat => cat.id === id);
                    if (!categoryToDelete) {
                        console.error("Category not found for deletion.");
                        return;
                    }
                    const categoryName = categoryToDelete.name;

                    // Remove category from products (only within this comercio)
                    const productsColForUpdate = getProductsCollection();
                    if (productsColForUpdate) {
                        const productsWithCategory = await productsColForUpdate.where('categories', 'array-contains', categoryName).get();
                        const batch = db.batch();
                        productsWithCategory.docs.forEach(doc => {
                            const product = doc.data();
                            const updatedCategories = product.categories.filter(cat => cat !== categoryName);
                            batch.update(doc.ref, { categories: updatedCategories });
                        });
                        await batch.commit();
                    }

                    // Delete the category itself
                    await categoriesColRef.doc(id).delete();

                    console.log('Categoría eliminada con éxito!');
                    showMessage('Eliminación Exitosa', 'Categoría eliminada con éxito!');
                    fetchCategories();
                    fetchProducts();
                } catch (error) {
                    console.error("Error deleting category: ", error);
                    showMessage('Error al Eliminar', 'Error al eliminar la categoría.');
                }
            }
        }

        cancelCategoryEditButton.addEventListener('click', () => {
            categoryForm.reset();
            categoryIdInput.value = '';
        });

        // --- AUTHENTICATION LOGIC ---

        // Función para mostrar errores de autenticación
        function displayAuthError(message) {
            authErrorDisplay.textContent = message;
            authErrorDisplay.style.display = 'block';
        }

        function clearAuthError() {
            authErrorDisplay.textContent = '';
            authErrorDisplay.style.display = 'none';
        }

        // Abrir el modal de autenticación
        openAuthModalButton.addEventListener('click', () => {
            authForm.reset();
            clearAuthError();
            authModalTitle.textContent = 'Iniciar Sesión / Registrarse';
            openModal(authModal);
        });

        // Cerrar sesión
        signOutButton.addEventListener('click', async () => {
            try {
                await auth.signOut();
                // onAuthStateChanged se encargará de actualizar la UI
            } catch (error) {
                console.error('Error al cerrar sesión:', error);
                showMessage('Error al Cerrar Sesión', 'Error al cerrar sesión: ' + error.message);
            }
        });


        // Manejar inicio de sesión
        signInButton.addEventListener('click', async (e) => {
            e.preventDefault();
            clearAuthError();
            const email = authEmailInput.value;
            const password = authPasswordInput.value;

            try {
                await auth.signInWithEmailAndPassword(email, password);
                // La función onAuthStateChanged manejará la UI y la autorización
            } catch (error) {
                console.error('Error al iniciar sesión:', error);
                let errorMessage = 'Error al iniciar sesión.';
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = 'No hay ningún usuario con ese correo electrónico.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Contraseña incorrecta.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'El formato del correo electrónico es inválido.';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = 'El usuario ha sido deshabilitado.';
                        break;
                    default:
                        errorMessage = error.message;
                }
                displayAuthError(errorMessage);
            }
        });

        // Manejar registro
        signUpButton.addEventListener('click', async (e) => {
            e.preventDefault();
            clearAuthError();
            const email = authEmailInput.value;
            const password = authPasswordInput.value;

            if (password.length < 6) {
                displayAuthError('La contraseña debe tener al menos 6 caracteres.');
                return;
            }

            try {
                await auth.createUserWithEmailAndPassword(email, password);
                showMessage('Registro Exitoso', '¡Registro exitoso! Su cuenta necesita ser autorizada por el administrador. Por favor, espere.');
                closeModal(authModal);
                // onAuthStateChanged se encargará de la UI y la autorización después del registro
            } catch (error) {
                console.error('Error al registrarse:', error);
                let errorMessage = 'Error al registrarse.';
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'El correo electrónico ya está en uso.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'El formato del correo electrónico es inválido.';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'La contraseña es demasiado débil.';
                        break;
                    default:
                        errorMessage = error.message;
                }
                displayAuthError(errorMessage);
            }
        });

        // Observar el estado de autenticación (cuando el usuario inicia/cierra sesión)
        auth.onAuthStateChanged(async user => {
            if (user) {
                // Usuario autenticado, ahora verifica si está permitido
                currentUser = user;
                console.log('Usuario autenticado:', user.email, 'UID:', user.uid);

                try {
                    // Intenta leer el documento del usuario en la colección allowedUsers
                    const allowedUserDoc = await allowedUsersCollection.doc(user.uid).get();
                    console.log('Documento de allowedUsers existe para este UID:', allowedUserDoc.exists);

                    if (allowedUserDoc.exists) {
                        // El usuario está en la lista de permitidos
                        console.log('Usuario autorizado para acceder a funciones de administración.');
                        openAuthModalButton.style.display = 'none'; // Ocultar botón de iniciar sesión
                        signOutButton.style.display = 'block'; // Mostrar botón de cerrar sesión
                        showMessage('Bienvenido', 'Bienvenido, ' + user.email + '!'); // Muestra un mensaje de bienvenida
                        closeModal(authModal); // Cierra el modal de autenticación si está abierto

                        // Cargar datos y mostrar la pestaña de gestión de comercios (o la que corresponda)
                        const activeTab = document.querySelector('.tab-content.active');
                        if (activeTab) {
                            openTab(activeTab.id); 
                        } else {
                            openTab('comercio-gestion'); // Si no hay pestaña activa, ve a gestión de comercios
                        }

                    } else {
                        // El usuario NO está en la lista de permitidos
                        console.warn('Usuario autenticado pero NO autorizado:', user.email);
                        showMessage('Acceso No Autorizado', 'Su cuenta está registrada, pero aún no ha sido autorizada por el administrador. Por favor, contacte al soporte.');
                        await auth.signOut(); // Forzar el cierre de sesión para usuarios no autorizados
                        // onAuthStateChanged se disparará de nuevo y mostrará el estado de no autenticado
                    }
                } catch (error) {
                    console.error("Error al verificar autorización del usuario:", error);
                    showMessage('Error de Autorización', "Error al verificar su autorización. Intente nuevamente. " + error.message);
                    await auth.signOut(); // Cierre de sesión si hay un error al verificar
                }

            } else {
                // No hay usuario autenticado
                currentUser = null;
                console.log('No hay usuario autenticado.');
                openAuthModalButton.style.display = 'block'; // Mostrar botón de iniciar sesión
                signOutButton.style.display = 'none'; // Ocultar botón de cerrar sesión
                showMessage('Inicio de Sesión Requerido', 'Por favor, inicie sesión para gestionar el menú.'); // Muestra un mensaje para iniciar sesión

                // Limpiar contenido de las pestañas sensibles y redirigir
                productsListDiv.innerHTML = '<p>Necesita iniciar sesión para gestionar productos.</p>';
                categoriesListDiv.innerHTML = '<p>Necesita iniciar sesión para gestionar categorías.</p>';
                
                // Redirigir a la pestaña de gestión de comercios (donde está el botón de inicio de sesión)
                openTab('comercio-gestion'); 
            }
        });

        // --- INITIAL LOAD ---
        document.addEventListener('DOMContentLoaded', () => {
            // La lógica de carga inicial ahora es manejada por auth.onAuthStateChanged.
            // Una vez que Firebase determine si hay un usuario logueado o no,
            // onAuthStateChanged se disparará y llamará a openTab() con la lógica adecuada.
            // No necesitamos llamar a fetchComercios() o openTab() directamente aquí.
        });
    </script>
</body>
</html>
